<template>
  <n-modal
    v-model:show="visible"
    title="pnpm 配置"
    style="width: 700px"
    :mask-closable="!saving"
    :closable="!saving"
    :on-update:show="handleUpdateShow"
  >
    <n-card :bordered="false">
      <n-spin :show="loading" description="加载配置中...">
        <n-tabs v-model:value="activeTab" type="line" animated>
          <!-- 镜像源配置 -->
          <n-tab-pane name="registry" tab="📦 镜像源">
            <n-form label-placement="left" label-width="100px" style="margin-top: 12px">
              <n-form-item label="选择镜像源">
                <n-select
                  v-model:value="form.selectedMirror"
                  :options="mirrors.map(m => ({
                    label: `${m.displayName} ${m.location ? `(${m.location})` : ''}`,
                    value: m.name
                  }))"
                  placeholder="选择预设镜像源"
                  clearable
                  @update:value="handleMirrorChange"
                />
              </n-form-item>

              <n-form-item label="自定义 URL">
                <n-input
                  v-model:value="form.registry"
                  type="text"
                  placeholder="或手动输入镜像源地址"
                />
              </n-form-item>
            </n-form>
          </n-tab-pane>

          <!-- 代理配置 -->
          <n-tab-pane name="proxy" tab="🌐 代理">
            <n-form label-placement="left" label-width="100px" style="margin-top: 12px">
              <n-form-item label="代理设置">
                <n-radio-group v-model:value="form.proxyType">
                  <n-radio value="none">不使用代理</n-radio>
                  <n-radio value="global">使用全局代理</n-radio>
                  <n-radio value="custom">自定义代理</n-radio>
                </n-radio-group>
              </n-form-item>

              <n-form-item v-if="form.proxyType === 'global'" label="全局代理">
                <n-input
                  :value="globalProxyUrl"
                  readonly
                  placeholder="请先在设置页面配置全局代理"
                />
              </n-form-item>

              <n-form-item v-if="form.proxyType === 'custom'" label="代理 URL">
                <n-input
                  v-model:value="form.customProxy"
                  type="text"
                  placeholder="例如：http://127.0.0.1:1080"
                />
              </n-form-item>
            </n-form>
          </n-tab-pane>

          <!-- 缓存配置 -->
          <n-tab-pane name="cache" tab="💾 缓存">
            <n-form label-placement="left" label-width="100px" style="margin-top: 12px">
              <n-form-item label="缓存目录">
                <n-input
                  v-model:value="form.cacheDir"
                  type="text"
                  placeholder="例如：C:\pnpm-cache"
                />
              </n-form-item>
            </n-form>
          </n-tab-pane>
        </n-tabs>
      </n-spin>
    </n-card>

    <template #footer>
      <n-space justify="end">
        <n-button type="primary" @click="handleSave" :loading="saving" :disabled="saving">
          {{ saving ? '保存中...' : '保存配置' }}
        </n-button>
        <n-button @click="handleClose" :disabled="saving">关闭</n-button>
      </n-space>
    </template>
  </n-modal>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useMessage } from 'naive-ui'

const message = useMessage()

// Props
const props = defineProps<{
  show: boolean
  toolInfo: any
  mirrors: any[]
  globalProxyUrl: string
}>()

// Emits
const emit = defineEmits<{
  'update:show': [value: boolean]
  save: [config: any]
}>()

// 状态
const visible = computed({
  get: () => props.show,
  set: (val) => emit('update:show', val)
})

const activeTab = ref('registry')
const loading = ref(false)
const saving = ref(false)

// 表单数据
const form = ref({
  registry: '',
  selectedMirror: '',
  proxyType: 'none',
  customProxy: '',
  cacheDir: ''
})

// 监听弹窗打开，加载配置
watch(() => props.show, async (newVal) => {
  if (newVal && props.toolInfo) {
    loading.value = true
    
    // 加载表单数据
    form.value.registry = props.toolInfo.registry || ''
    form.value.cacheDir = props.toolInfo.cacheDir || ''
    form.value.proxyType = props.toolInfo.proxyType || 'none'
    form.value.customProxy = props.toolInfo.customProxy || ''
    
    loading.value = false
  }
})

// 镜像源选择
function handleMirrorChange(mirrorName: string) {
  const mirror = props.mirrors.find(m => m.name === mirrorName)
  if (mirror) {
    form.value.registry = mirror.registryUrl
  }
}

// 保存配置
function handleSave() {
  emit('save', {
    tab: activeTab.value,
    form: form.value
  })
}

// 关闭弹窗
function handleClose() {
  if (!saving.value) {
    visible.value = false
  }
}

// 处理弹窗显示更新
function handleUpdateShow(show: boolean) {
  if (!saving.value) {
    emit('update:show', show)
  }
}

// 暴露方法给父组件
defineExpose({
  setSaving: (val: boolean) => { saving.value = val },
  updateForm: (data: any) => { Object.assign(form.value, data) }
})
</script>
